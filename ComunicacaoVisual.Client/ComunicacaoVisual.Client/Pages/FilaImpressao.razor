@page "/fila-impressao"
@using ComunicacaoVisual.Client.Models
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IJSRuntime JS

<style>
    /* 1. Cabeçalho em BRANCO */
    .table-custom thead th {
        background-color: #1a1a1a;
        color: white !important; /* Força o branco */
        padding: 15px;
        border-bottom: 2px solid #ffc107;
    }

    /* 2. Caixa de Observação ao passar o mouse (Tooltip) */
    .obs-container {
        cursor: help;
        position: relative;
        display: inline-block;
    }

    .obs-container:hover .obs-tooltip {
        display: block;
    }

    .obs-tooltip {
        display: none;
        position: absolute;
        z-index: 100;
        background: #333;
        color: #fff;
        padding: 10px;
        border: 1px solid #ffc107;
        border-radius: 5px;
        width: 250px;
        top: 25px;
        left: 0;
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    /* Estilo Dark Mode para a página */
    .page-container {
        background-color: #121212;
        min-height: 100vh;
        padding: 20px;
        color: white;
    }

    h3 {
        color: #ffc107;
        font-weight: bold;
        margin-bottom: 25px;
    }

    /* Tabela Estilizada */
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px; /* Espaçamento entre as linhas */
    }

    .table-custom thead th {
        background-color: #1a1a1a;
        color: #ffc107;
        padding: 15px;
        text-transform: uppercase;
        font-size: 0.85rem;
        border: none;
    }

    /* Linhas com fundo amarelo transparente */
    .table-custom tbody tr {
        background-color: rgba(255, 193, 7, 0.1);
        transition: all 0.2s ease;
    }

    .table-custom tbody tr:hover {
        background-color: rgba(255, 193, 7, 0.2);
        transform: translateY(-2px);
    }

    .table-custom td {
        padding: 15px;
        vertical-align: middle;
        border: none;
    }

    /* Ajustes de texto */
    .text-muted-light { color: #aaaaaa !important; }
    .obs-tecnica { color: #ff6b6b; font-style: italic; }
    .badge-material { background-color: #ffc107; color: #000; font-weight: bold; padding: 5px 10px; border-radius: 4px; }
</style>

<div class="page-container">
    <h3>Fila de Impressão Ativa</h3>

    <table class="table-custom">
        <thead>
            <tr>
                <th>OS</th>
                <th>Amostra</th>
                <th>Produto / Observações</th>
                <th>Material</th>
                <th>Medidas</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @if (pedidos != null)
            {
                foreach (var p in pedidos)
                {
                    <tr>
                        <td><strong>@p.OS</strong></td>
                        <td>
                            @if (!string.IsNullOrEmpty(p.Caminho_Foto))
                            {
                                <img src="@p.Caminho_Foto" style="width: 70px; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #ffc107;" />
                            }
                            else
                            {
                                <div style="width: 70px; height: 70px; background: #222; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                    <span class="text-muted-light" style="font-size: 10px;">Sem foto</span>
                                </div>
                            }
                        </td>
                       <td>
    <div class="obs-container">
        <strong>@p.Produto</strong>
        <div class="obs-tooltip">
            <strong>📋 Geral:</strong> @(p.Observacao_Geral ?? "Sem obs") <br />
            <hr style="border-color: #555" />
            <strong>🛠 Técnica:</strong> @(p.Observacao_Tecnica ?? "Sem obs")
        </div>
    </div>
    <br />
    <small class="text-muted-light">Passe o mouse para ver detalhes</small>
</td>
                        <td>
                            <span class="badge-material">@p.MaterialBase</span>
                        </td>
                        <td>
                            <div style="font-size: 0.9rem;">
                                <strong>@p.Largura x @p.Altura</strong><br />
                                <span class="text-muted-light">Qtd: @p.Quantidade</span>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="@p.Link_Arte" target="_blank" class="btn btn-outline-info btn-sm me-2">
                                    <i class="oi oi-external-link"></i> Arte
                                </a>
                                <button class="btn btn-success btn-sm" @onclick="() => ConcluirImpressao(p.OS)">
                                    Pronto
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center">Carregando fila de produção...</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private List<FilaImpressaoDTO>? pedidos;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
            }

            // URL Corrigida (Sem espaços e acentos como no Backend)
            pedidos = await Http.GetFromJsonAsync<List<FilaImpressaoDTO>>("api/Producao/FilaImpressao");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erro ao carregar: " + ex.Message);
            pedidos = new List<FilaImpressaoDTO>();
        }
    }

    private async Task ConcluirImpressao(string os)
    {
        var confirmar = await JS.InvokeAsync<bool>("confirm", $"A OS {os} está pronta para o acabamento?");

        if (confirmar)
        {
            // Lembre-se: O endpoint "AtualizarStatus" deve estar sem espaços no Backend
            var dados = new { PedidoId = 0, NovoStatusId = 5, UsuarioId = 1, OS = os };

            var response = await Http.PutAsJsonAsync("api/Producao/AtualizarStatus", dados);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Sucesso! O pedido foi para o Acabamento.");
                pedidos?.RemoveAll(x => x.OS == os);
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Erro ao atualizar status no servidor.");
            }
        }
    }   
}