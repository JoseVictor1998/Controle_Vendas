@page "/fila-trabalho"
@using ComunicacaoVisual.Client.Models
@inject HttpClient Http
@inject IJSRuntime JS

<h3><i class="bi bi-list-task"></i> Minha Fila de Trabalho (@nivelUsuario)</h3>

@if (pedidos == null)
{
    <p>Carregando sua lista de tarefas...</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>OS</th>
                    <th>Cliente</th>
                    <th>Produto</th>
                    <th>Medidas</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in pedidos)
                {
                    <tr>
                        <td>@p.OS</td>
                        <td>@p.Cliente</td>
                        <td>@p.Produto</td>
                        <td>@p.Largura x @p.Altura</td>
                        <td>
                            <button class="btn btn-sm btn-success">Iniciar</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<FilaProducaoDTO>? pedidos;
    private string? nivelUsuario;

    protected override async Task OnInitializedAsync()
    {
        nivelUsuario = await JS.InvokeAsync<string>("localStorage.getItem", "userLevel");
        await CarregarFilaEspecifica();
    }

    private async Task CarregarFilaEspecifica()
    {
        var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
        Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

        // A MÁGICA: Cada um só chama o seu endpoint
        string endpoint = nivelUsuario switch
        {
            "Arte" => "api/Producao/Fila Arte",
            "Impressao" => "api/Producao/Fila Impressão",
            _ => "api/Producao/Fila Producao Completa" // God/Admin vê tudo
        };

        pedidos = await Http.GetFromJsonAsync<List<FilaProducaoDTO>>(endpoint);
    }
}