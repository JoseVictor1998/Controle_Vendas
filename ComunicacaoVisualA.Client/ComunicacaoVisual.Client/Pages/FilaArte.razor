@page "/fila-arte"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using ComunicacaoVisual.Client.Models
@using ComunicacaoVisual.Client.Services
@attribute [Authorize(Roles = "God,Admin,Arte,Vendedor")]
@inject IJSRuntime JS
@inject FilaArteService Service
@inject AuthenticationStateProvider AuthStateProvider

<style>
    .page-container { background-color: #0f172a; min-height: 100vh; padding: 2rem; color: #f8fafc; }
    .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }

    .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 0.75rem; }
    .custom-table thead th { color: #94a3b8; text-transform: uppercase; font-size: 0.75rem; padding: 1rem; border: none; }

    .row-base { background-color: #1e293b; transition: all 0.2s; border-radius: 8px; }
    .row-base:hover { background-color: #334155; transform: scale(1.005); }

    .row-delayed { background-color: rgba(127, 29, 29, 0.3) !important; border-left: 4px solid #ef4444; }
    .text-delayed { color: #f87171; font-weight: bold; }

    .material-pill { background-color: #fedf00; color: #0f172a; padding: 2px 10px; border-radius: 4px; font-weight: 700; font-size: 0.8rem; }

    /* Tooltip ajustado para abrir à direita e não ser cortado */
    .obs-box { cursor: help; position: relative; display: inline-block; }
    .obs-content {
        display: none; position: absolute; z-index: 100; background: #0f172a; border: 1px solid #334155;
        padding: 1rem; border-radius: 0.5rem; width: 320px; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5);
        color: #f8fafc; text-align: left;
        left: 0; top: 100%;
    }
    .obs-box:hover .obs-content { display: block; }

    /* Estilo dos botões e select */
    .btn-action { background: #334155; color: #fedf00; border: 1px solid #475569; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 28px; }
    .btn-action:hover { background: #fedf00; color: #0f172a; }
    .status-select { background: #0f172a; color: #fedf00; border: 1px solid #334155; border-radius: 4px; font-size: 0.75rem; padding: 2px; height: 28px; }
</style>

<div class="page-container">
    <div class="header-section">
        <div>
            <h1 style="font-size: 1.5rem; font-weight: 700;">Fila de Arte</h1>
            <p style="color: #94a3b8; font-size: 0.875rem;">Pedidos aguardando criação/aprovação de arte</p>
        </div>
        @if (lista?.Count > 0)
        {
            <div style="background:#fedf00;color:#0f172a;padding:.5rem 1rem;border-radius:9999px;font-weight:bold;">
                @lista.Count Itens na fila
            </div>
        }
    </div>

    <table class="custom-table">
        <thead>
            <tr>
                <th>Tempo</th>
                <th>OS</th>
                <th>Cliente</th>
                <th>Obs</th> @* <-- Movido para cá *@
                <th>Produto</th>
                <th>Dimensões</th>
                <th>Qtd</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @if (lista == null)
            {
                <tr><td colspan="9" class="text-center p-5">Carregando fila de arte...</td></tr>
            }
            else if (lista.Count == 0)
            {
                <tr><td colspan="9" class="text-center p-5 text-muted">Nenhum pedido na fila de arte.</td></tr>
            }
            else
            {
                foreach (var item in lista)
                {
                    var dias = item.DiasAguardandoArte ?? 0;
                    bool atrasado = dias > 2;

                    <tr class="row-base @(atrasado ? "row-delayed" : "")">
                        <td style="padding:1rem;">
                            <span class="@(atrasado ? "text-delayed" : "")">
                                <i class="oi oi-timer"></i> @(dias == 0 ? "Novo" : $"{dias}d")
                            </span>
                        </td>
                        <td style="font-weight:700;padding:1rem;">@item.OS</td>
                        <td style="padding:1rem;color:#e2e8f0;">@item.Cliente</td>
                        
                        @* Coluna de Observações *@
                        <td style="padding:1rem;">
                            <div class="obs-box">
                                <span style="color:#94a3b8; text-decoration: underline;">Ver</span>
                                <div class="obs-content">
                                    <strong style="color:#fedf00;">📋 Geral:</strong><br />
                                    <span>@(string.IsNullOrWhiteSpace(item.ObservacaoGeral) ? "-" : item.ObservacaoGeral)</span><br /><br />
                                    <strong style="color:#f87171;">🛠 Técnica:</strong><br />
                                    <span>@(string.IsNullOrWhiteSpace(item.ObservacaoTecnica) ? "-" : item.ObservacaoTecnica)</span>
                                </div>
                            </div>
                        </td>

                        <td style="padding:1rem;color:#e2e8f0;">@item.Produto</td>
                        <td style="padding:1rem;">
                            <span>@item.Largura.ToString("N2") x @item.Altura.ToString("N2")</span>
                        </td>
                        <td style="padding:1rem;color:#e2e8f0;">@item.Quantidade</td>
                        
                        <td style="padding:1rem;">
                            <span class="material-pill">@item.StatusArte</span>
                        </td>

                        @* Coluna de Ações Mesclada *@
                        <td style="padding:1rem;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                
                                @* 1. Seletor de Status *@
                                <select class="status-select" @onchange="@(e => AlterarStatus(e, item.ItemId))">
                                    <option value="2" selected="@(item.StatusArte == "Enviada")">Enviada</option>
                                    <option value="3" selected="@(item.StatusArte == "Em Correção")">Em Correção</option>
                                    <option value="4">Aprovar</option>
                                    <option value="5">Reprovar</option>
                                </select>

                                @* 2. Botão de Download *@
                                @if (item.ArquivoId > 0)
                                {
                                    <button class="btn-action" style="color: #60a5fa;" @onclick="() => BaixarEProcessar(item.ArquivoId)" title="Baixar Arte">
                                        <i class="oi oi-data-transfer-download"></i>
                                    </button>
                                }

                                @* 3. Botão de Upload *@
                                <label class="btn-action" style="margin-bottom: 0;" title="Vincular Arte">
                                    <i class="oi oi-cloud-upload"></i>
                                    <InputFile OnChange="@(e => SelecionarArquivo(e, item.ItemId))" style="display:none;" />
                                </label>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private List<FilaArteDTO>? lista;
    private bool processando = false;
    private int usuarioLogadoId;

    protected override async Task OnInitializedAsync()
    {
        await ObterUsuarioLogado();
        await CarregarFila();
    }

    private async Task ObterUsuarioLogado()
    {
        // Obtém o estado de autenticação e busca a Claim "UsuarioId" definida no seu Token JWT
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var claimId = user.FindFirst("UsuarioId")?.Value;
        
        if (!int.TryParse(claimId, out usuarioLogadoId))
        {
            usuarioLogadoId = 2; // Valor padrão admin para testes se necessário
        }
    }

    private async Task CarregarFila()
    {
        try { lista = await Service.Listar(); }
        catch { lista = new(); }
    }

    private async Task BaixarEProcessar(int? arquivoId)
    {
        if (arquivoId == null || arquivoId == 0) return;
        var (bytes, type, name) = await Service.BaixarArquivo(arquivoId.Value);
        if (bytes != null)
        {
            using var stream = new MemoryStream(bytes);
            using var streamRef = new DotNetStreamReference(stream);
            await JS.InvokeVoidAsync("downloadFileFromStream", name, streamRef);
        }
    }

    private async Task SelecionarArquivo(InputFileChangeEventArgs e, int itemId)
    {
        var file = e.File;
        if (file == null) return;
        processando = true;
        var sucesso = await Service.VincularArte(itemId, file);
        if (sucesso) await CarregarFila();
        processando = false;
        StateHasChanged();
    }

    private async Task AlterarStatus(ChangeEventArgs e, int itemId)
    {
        if (int.TryParse(e.Value?.ToString(), out int novoStatusId))
        {
            // Passamos o ID dinâmico capturado do Token para o Service
            var sucesso = await Service.MudarStatus(itemId, novoStatusId, usuarioLogadoId);
            if (sucesso) 
            {
                await CarregarFila(); // O item aprovado sumirá da fila automaticamente
                StateHasChanged();
            }
        }
    }
}