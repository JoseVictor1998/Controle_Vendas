@page "/fila-impressao"
@using ComunicacaoVisual.Client.Models
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IJSRuntime JS

<style>
    .page-container { background-color: #0f172a; min-height: 100vh; padding: 2rem; color: #f8fafc; }
    
    .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    
    .new-orders-badge { 
        background-color: #fedf00; color: #0f172a; padding: 0.5rem 1rem; 
        border-radius: 9999px; font-weight: bold; display: flex; align-items: center; gap: 0.5rem;
    }

    .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 0.75rem; }
    .custom-table thead th { color: #94a3b8; text-transform: uppercase; font-size: 0.75rem; padding: 1rem; border: none; }
    
    .row-base { background-color: #1e293b; transition: all 0.2s; border-radius: 8px; }
    .row-base:hover { background-color: #334155; transform: scale(1.005); }
    
    /* ALERTA DE ATRASO ESTILO BASE 44 */
    .row-delayed { background-color: rgba(127, 29, 29, 0.3) !important; border-left: 4px solid #ef4444; }
    .text-delayed { color: #f87171; font-weight: bold; animation: pulse 2s infinite; }

    .material-pill { background-color: #fedf00; color: #0f172a; padding: 2px 10px; border-radius: 4px; font-weight: 700; font-size: 0.8rem; }

    @@keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    /* TOOLTIP INTERATIVO */
    .obs-box { cursor: help; position: relative; display: inline-block; }
    .obs-content { 
        display: none; position: absolute; z-index: 50; background: #0f172a; border: 1px solid #334155;
        padding: 1rem; border-radius: 0.5rem; width: 300px; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5);
    }
    .obs-box:hover .obs-content { display: block; }
</style>

<div class="page-container">
    <div class="header-section">
        <div>
            <h1 style="font-size: 1.5rem; font-weight: 700;">Fila de Impressão</h1>
            <p style="color: #94a3b8; font-size: 0.875rem;">Pedidos com arte aprovada, prontos para impressão</p>
        </div>
        @if (pedidos?.Count(p => p.DiasEmImpressao == 0) > 0)
        {
            <div class="new-orders-badge">
                <i class="oi oi-bell"></i> @pedidos.Count(p => p.DiasEmImpressao == 0) Novos Pedidos
            </div>
        }
    </div>

    <table class="custom-table">
        <thead>
            <tr>
                <th>Foto</th>
                <th>Tempo</th>
                <th>OS</th>
                <th>Produto / Cliente</th>
                <th>Material</th>
                <th>Dimensões</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @if (pedidos != null)
            {
                foreach (var p in pedidos)
                {
                    bool atrasado = p.DiasEmImpressao > 1;
                    <tr class="row-base @(atrasado ? "row-delayed" : "")">
                        <td style="width: 80px; padding: 1rem;">
                            @if (!string.IsNullOrEmpty(p.Caminho_Foto))
                            {
                                <img src="@p.Caminho_Foto" 
                                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid #334155;" 
                                     alt="Miniatura" />
                            }
                            else
                            {
                                <div style="width: 50px; height: 50px; background: #1e293b; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                    <i class="oi oi-image" style="color: #475569;"></i>
                                </div>
                            }
                        </td>

                        <td style="padding: 1rem;">
                            <div class="flex items-center gap-2 @(atrasado ? "text-delayed" : "")">
                                <i class="oi oi-timer"></i>
                                @(p.DiasEmImpressao == 0 ? "Novo" : p.DiasEmImpressao + "d")
                            </div>
                        </td>
                        <td style="font-weight: 700;">@p.OS</td>
                        <td>
                            <div class="obs-box">
                                <span style="font-weight: 600;">@p.Produto</span>
                                <div class="obs-content">
                                    <strong style="color: #fedf00;">📋 Geral:</strong><br/>
                                    <span>@(p.Observacao_Geral ?? "-")</span><br/><br/>
                                    <strong style="color: #f87171;">🛠 Técnica:</strong><br/>
                                    <span>@(p.Observacao_Tecnica ?? "-")</span>
                                </div>
                            </div><br/>
                            <small style="color: #94a3b8;">@p.Cliente</small>
                        </td>
                        <td><span class="material-pill">@p.MaterialBase</span></td>
                        <td>
                            <span>@p.Largura x @p.Altura</span><br/>
                            <small style="color: #94a3b8;">Qtd: @p.Quantidade</small>
                        </td>
                        <td>
                            <div class="btn-group">
                                @* --- AJUSTE AQUI: Prioriza download por ArquivoId --- *@
                                @if (p.ArquivoId > 0)
                                {
                                    <button class="btn btn-outline-info btn-sm" @onclick="() => BaixarArte(p.ArquivoId)" title="Baixar do Servidor">
                                        <i class="oi oi-data-transfer-download"></i> Baixar
                                    </button>
                                }
                                else if (TemLinkValido(p.LinkArte))
                                {
                                    <a href="@NormalizarLinkArte(p.LinkArte)" target="_blank" rel="noopener noreferrer" class="btn btn-outline-info btn-sm">Abrir Link</a>
                                }
                                else
                                {
                                    <button class="btn btn-outline-secondary btn-sm" disabled title="Sem arquivo disponível">Sem Arte</button>
                                }

                                <button class="btn btn-success btn-sm" @onclick="() => Concluir(p)">Concluir</button>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private List<FilaImpressaoDTO>? pedidos;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (!string.IsNullOrEmpty(token))
                Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            pedidos = await Http.GetFromJsonAsync<List<FilaImpressaoDTO>>("api/Producao/FilaImpressao");
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); pedidos = new(); }
    }

    // 🚀 NOVO MÉTODO: Download usando o endpoint que você criou ontem
    private async Task BaixarArte(int? arquivoId)
    {
        if (arquivoId == null || arquivoId == 0) return;

        try 
        {
            var response = await Http.GetAsync($"api/Producao/DownloadArte/{arquivoId}");

            if (response.IsSuccessStatusCode)
            {
                var bytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = response.Content.Headers.ContentDisposition?.FileName ?? $"arte_os_{arquivoId}.pdf";

                using var stream = new MemoryStream(bytes);
                using var streamRef = new DotNetStreamReference(stream);

                // Dispara o download no navegador (precisa da função JS no index.html)
                await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
            }
            else 
            {
                await JS.InvokeVoidAsync("alert", "Erro: Arquivo não encontrado no servidor.");
            }
        }
        catch (Exception ex) 
        {
            Console.WriteLine($"Erro no download: {ex.Message}");
        }
    }

     private async Task Concluir(FilaImpressaoDTO p)
{
    // Usamos o p.OS apenas para a mensagem de confirmação visual para o usuário
    if (await JS.InvokeAsync<bool>("confirm", $"Confirmar conclusão da OS {p.OS}?"))
    {
        // 🚀 O SEGREDO: Enviamos o ItemId para a API localizar o pedido no banco
        // Note que o seu DTO já tem essa propriedade mapeada
        var request = new { ItemId = p.ItemId, NovoStatusId = 5 };
        
        var res = await Http.PutAsJsonAsync("api/Producao/AtualizarStatus", request);

        if (res.IsSuccessStatusCode) 
        {
            // Remove da tela apenas se o banco de dados confirmou a gravação (Status 200)
            pedidos?.RemoveAll(x => x.ItemId == p.ItemId);
        }
        else 
        {
            // Se cair aqui, a API avisará que o banco não mudou
            await JS.InvokeVoidAsync("alert", "Erro: O banco de dados não conseguiu atualizar o status.");
        }
    }
}

    private static bool TemLinkValido(string? linkArte)
    {
        if (string.IsNullOrWhiteSpace(linkArte)) return false;
        var linkNormalizado = NormalizarLinkArte(linkArte);
        return Uri.TryCreate(linkNormalizado, UriKind.Absolute, out _);
    }

    private static string NormalizarLinkArte(string? linkArte)
    {
        if (string.IsNullOrWhiteSpace(linkArte)) return string.Empty;
        var linkLimpo = linkArte.Trim();
        if (Uri.TryCreate(linkLimpo, UriKind.Absolute, out _)) return linkLimpo;
        return $"https://{linkLimpo.TrimStart('/')}";
    }
}